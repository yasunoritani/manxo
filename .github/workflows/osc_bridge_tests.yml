name: LLM-Max MCP Integration via OSC Bridge Tests

# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€MCPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã¦LLMï¼ˆClaude Desktopï¼‰ã¨Maxã‚’é€£æºã•ã›ã‚‹ãŸã‚ã®
# OSC Bridgeå®Ÿè£…ã®å“è³ªã‚’ä¿è¨¼ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

on:
  push:
    branches: [ main, feature/*, release/* ]
    paths:
      - 'src/min-devkit/osc_bridge/**'
      - '.github/workflows/osc_bridge_tests.yml'
      - 'run_tests.sh'
      - 'oscpack/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/min-devkit/osc_bridge/**'
      - 'run_tests.sh'
      - 'oscpack/**'

jobs:
  basic-checks:
    name: Repository Structure Check
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Verify Project Structure
        run: |
          echo "ğŸ”’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ç¢ºèªä¸­..."
          
          # åŸºæœ¬çš„ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã®ç¢ºèª
          if [ ! -d "$GITHUB_WORKSPACE/src/min-devkit/osc_bridge" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: OSC Bridgeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          if [ ! -d "$GITHUB_WORKSPACE/oscpack" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: oscpackãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          if [ ! -f "$GITHUB_WORKSPACE/run_tests.sh" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ç¢ºèªå®Œäº†"
          
  test:
    name: OSC Bridge Tests on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: basic-checks
    strategy:
      fail-fast: false
      matrix:
        os: [macos-11, macos-latest]  # Intel Macã¨Apple Silicon Macã®ä¸¡æ–¹ã‚’ã‚«ãƒãƒ¼
    
    steps:
      - name: Check out repository with submodules
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'
          fetch-depth: 0
      
      - name: Verify Project Integrity
        run: |
          echo "ğŸ” ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•´åˆæ€§ã®æ¤œè¨¼..."
          
          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªï¼ˆæ‹¡å¼µï¼‰
          REQUIRED_FILES=(
            "$GITHUB_WORKSPACE/src/min-devkit/osc_bridge/CMakeLists.txt"
            "$GITHUB_WORKSPACE/run_tests.sh"
            "$GITHUB_WORKSPACE/oscpack/CMakeLists.txt"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ã‚¨ãƒ©ãƒ¼: å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ« $file ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              exit 1
            fi
          done
          
          # MCPé–¢é€£ã®é«˜åº¦ãªæ¤œè¨¼
          echo "ğŸ”¬ MCPå®Ÿè£…ã®è©³ç´°æ¤œè¨¼..."
          
          # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ï¼ˆã‚ˆã‚ŠåŒ…æ‹¬çš„ï¼‰
          MCP_KEYWORDS=("MCP" "Model Context Protocol" "Claude Desktop" "LLM" "oscpack" "osc_bridge")
          MCP_FILES_FOUND=0
          
          for keyword in "${MCP_KEYWORDS[@]}"; do
            KEYWORD_COUNT=$(grep -r "$keyword" --include="*.{cpp,hpp,h,md,txt}" $GITHUB_WORKSPACE/src/min-devkit/osc_bridge | wc -l)
            if [ "$KEYWORD_COUNT" -gt 0 ]; then
              echo "âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ '$keyword' ã‚’ $KEYWORD_COUNT ç®‡æ‰€ã§æ¤œå‡º"
              MCP_FILES_FOUND=1
            fi
          done
          
          # MCPç‰¹æœ‰ã®ã‚³ãƒ¼ãƒ‰æ§‹é€ æ¤œè¨¼
          MCP_HANDLER_EXISTS=0
          if find "$GITHUB_WORKSPACE/src/min-devkit/osc_bridge" -name "*claude*.hpp" -o -name "*mcp*.hpp" | grep -q .; then
            echo "âœ… MCP/Claudeé–¢é€£ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º"
            MCP_HANDLER_EXISTS=1
          fi
          
          if [ "$MCP_FILES_FOUND" -eq 0 ] && [ "$MCP_HANDLER_EXISTS" -eq 0 ]; then
            echo "âš ï¸ è­¦å‘Š: MCPé–¢é€£ã®å®Ÿè£…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ã‚¢æ©Ÿèƒ½ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          fi
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã®æ¤œè¨¼
          if [ ! -d "$GITHUB_WORKSPACE/src/min-devkit/osc_bridge" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: OSC Bridgeã®å®Ÿè£…ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # oscpackã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç¢ºèªï¼ˆè©³ç´°ï¼‰
          if [ ! -d "$GITHUB_WORKSPACE/oscpack" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: oscpackã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          else
            # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ­£ç¢ºãªãƒãƒ¼ã‚¸ãƒ§ãƒ³/çŠ¶æ…‹ã‚’ç¢ºèª
            cd "$GITHUB_WORKSPACE/oscpack"
            echo "ğŸ“Š oscpackã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®çŠ¶æ…‹:"
            git status --short
            git log -1 --oneline
          fi
          
          echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•´åˆæ€§ã®æ¤œè¨¼å®Œäº†"
      
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
          brew install cmake
          
          # oscpackã®ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒ“ãƒ«ãƒ‰
          echo "ğŸ”¨ oscpackã®ãƒ“ãƒ«ãƒ‰ã‚’é–‹å§‹..."
          cd $GITHUB_WORKSPACE/oscpack
          if [ -f "./build_universal.sh" ]; then
            chmod +x ./build_universal.sh
            ./build_universal.sh
            echo "âœ… oscpackã®ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒ“ãƒ«ãƒ‰å®Œäº†"
          else
            echo "âš ï¸ è­¦å‘Š: build_universal.sh ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ“ãƒ«ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™"
            mkdir -p build && cd build
            cmake .. && make
            echo "âœ… oscpackã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ“ãƒ«ãƒ‰å®Œäº†"
          fi
          
          # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
          if [ -f "$GITHUB_WORKSPACE/oscpack/build_universal/liboscpack.a" ]; then
            echo "âœ… ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒã‚¤ãƒŠãƒªãŒæ­£å¸¸ã«ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¾ã—ãŸ"
            file $GITHUB_WORKSPACE/oscpack/build_universal/liboscpack.a
          elif [ -f "$GITHUB_WORKSPACE/oscpack/build/liboscpack.a" ]; then
            echo "âš ï¸ è­¦å‘Š: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ“ãƒ«ãƒ‰ã®ã¿ãŒå­˜åœ¨ã—ã¾ã™ - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®äº’æ›æ€§ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            file $GITHUB_WORKSPACE/oscpack/build/liboscpack.a
          else
            echo "âŒ ã‚¨ãƒ©ãƒ¼: oscpackã®ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi
          
      - name: Create Test Output Directory
        run: |
          mkdir -p "$GITHUB_WORKSPACE/docs/test_results"
          mkdir -p "$GITHUB_WORKSPACE/logs"
          echo "ğŸ“ ãƒ†ã‚¹ãƒˆå‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã—ãŸ"
      
      - name: Build and Run Legacy Tests
        id: legacy_tests
        run: |
          echo "::group::Legacy Tests (Min-DevKitä¾å­˜)"
          chmod +x $GITHUB_WORKSPACE/run_tests.sh
          
          # è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›ã‚’ä¿å­˜
          $GITHUB_WORKSPACE/run_tests.sh --legacy --verbose 2>&1 | tee "$GITHUB_WORKSPACE/logs/legacy_tests_$(date +%Y%m%d_%H%M%S).log"
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          
          # ãƒ†ã‚¹ãƒˆå†…å®¹ã®ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
          if [ -f "$GITHUB_WORKSPACE/build/test-results/legacy_summary.txt" ]; then
            cp "$GITHUB_WORKSPACE/build/test-results/legacy_summary.txt" "$GITHUB_WORKSPACE/docs/test_results/"
          else
            echo "ãƒ†ã‚¹ãƒˆçµæœ: çµ‚äº†ã‚³ãƒ¼ãƒ‰ $TEST_EXIT_CODE" > "$GITHUB_WORKSPACE/docs/test_results/legacy_summary_$(date +%Y%m%d_%H%M%S).txt"
          fi
          
          echo "::endgroup::"
          exit $TEST_EXIT_CODE
        continue-on-error: true
        
      - name: Build and Run Standalone Tests
        id: standalone_tests
        run: |
          echo "::group::Standalone Tests (Min-DevKitéä¾å­˜)"
          chmod +x $GITHUB_WORKSPACE/run_tests.sh
          
          # è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›ã‚’ä¿å­˜
          $GITHUB_WORKSPACE/run_tests.sh --standalone --verbose 2>&1 | tee "$GITHUB_WORKSPACE/logs/standalone_tests_$(date +%Y%m%d_%H%M%S).log"
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          
          # ãƒ†ã‚¹ãƒˆå†…å®¹ã®ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
          if [ -f "$GITHUB_WORKSPACE/build/test-results/standalone_summary.txt" ]; then
            cp "$GITHUB_WORKSPACE/build/test-results/standalone_summary.txt" "$GITHUB_WORKSPACE/docs/test_results/"
          else 
            echo "ãƒ†ã‚¹ãƒˆçµæœ: çµ‚äº†ã‚³ãƒ¼ãƒ‰ $TEST_EXIT_CODE" > "$GITHUB_WORKSPACE/docs/test_results/standalone_summary_$(date +%Y%m%d_%H%M%S).txt"
          fi
          
          echo "::endgroup::"
          exit $TEST_EXIT_CODE
        continue-on-error: true
        
      - name: Check Test Results and Collect Diagnostics
        run: |
          echo "::group::ãƒ†ã‚¹ãƒˆçµæœã®ç¢ºèªã¨è¨ºæ–­æƒ…å ±ã®åé›†"
          echo "å¾“æ¥ã®ãƒ†ã‚¹ãƒˆ: ${{ steps.legacy_tests.outcome == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}"
          echo "ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ†ã‚¹ãƒˆ: ${{ steps.standalone_tests.outcome == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}"
          
          # ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®è©³ç´°è¨ºæ–­æƒ…å ±ã‚’åé›†
          if [[ "${{ steps.legacy_tests.outcome }}" != "success" || "${{ steps.standalone_tests.outcome }}" != "success" ]]; then
            echo "ğŸ” è¨ºæ–­æƒ…å ±ã®åé›†..."
            
            # ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±
            echo "\n--- ã‚·ã‚¹ãƒ†ãƒ æƒ…å ± ---" > "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log"
            uname -a >> "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log"
            sw_vers >> "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log" 2>/dev/null || true
            
            # CMakeæƒ…å ±
            echo "\n--- CMakeæƒ…å ± ---" >> "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log"
            cmake --version >> "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log"
            
            # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ç¢ºèª
            echo "\n--- ãƒ“ãƒ«ãƒ‰æˆæœç‰© ---" >> "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log"
            find "$GITHUB_WORKSPACE/build" -type f -name "*.a" -o -name "*.o" -o -name "*.dylib" | \
              sort >> "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log"
            
            # ä¾å­˜é–¢ä¿‚ã®ç¢ºèª
            echo "\n--- oscpackä¾å­˜é–¢ä¿‚ ---" >> "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log"
            if [ -f "$GITHUB_WORKSPACE/oscpack/build_universal/liboscpack.a" ]; then
              file "$GITHUB_WORKSPACE/oscpack/build_universal/liboscpack.a" >> "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log"
            elif [ -f "$GITHUB_WORKSPACE/oscpack/build/liboscpack.a" ]; then
              file "$GITHUB_WORKSPACE/oscpack/build/liboscpack.a" >> "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log"
            fi
            
            # ãƒªãƒ³ã‚¯ã®å•é¡Œã‚’è¨ºæ–­
            echo "\n--- ãƒªãƒ³ã‚¯è¨ºæ–­ ---" >> "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log"
            find "$GITHUB_WORKSPACE/build" -name "CMakeError.log" -exec cat {} \; >> "$GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log" 2>/dev/null || true
            
            echo "è¨ºæ–­æƒ…å ±ã‚’ $GITHUB_WORKSPACE/logs/diagnostics_$(date +%Y%m%d_%H%M%S).log ã«ä¿å­˜ã—ã¾ã—ãŸ"
          fi
          
          # å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹å ´åˆã¯æˆåŠŸã¨ã™ã‚‹
          if [[ "${{ steps.legacy_tests.outcome }}" == "success" || "${{ steps.standalone_tests.outcome }}" == "success" ]]; then
            echo "âœ… å°‘ãªãã¨ã‚‚1ã¤ã®ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆãŒæˆåŠŸã—ã¾ã—ãŸã€‚"
          else
            echo "âŒ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚"
            # è¨ºæ–­ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
            echo "ãƒ†ã‚¹ãƒˆå¤±æ•—ã®ä¸»ãªåŸå› ã‚’è¨ºæ–­ä¸­..."
            grep -i "error" "$GITHUB_WORKSPACE/logs/"*.log | head -n 10 || true
            exit 1
          fi
          echo "::endgroup::"
      
      - name: Upload test results and diagnostics
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-diagnostics-${{ matrix.os }}
          path: |
            ${{ github.workspace }}/docs/test_results/
            ${{ github.workspace }}/logs/
            ${{ github.workspace }}/build/test-results/
            ${{ github.workspace }}/build/Testing/
          retention-days: 14
          # æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã¯é™¤å¤–
          exclude: |
            **/.env*
            **/.windsurfrules
            **/tools/**
            **/secure_config/**
            **/private/**
            **/credentials/**
            **/*token*
            **/*password*
            **/*secret*
            **/*.key
      
      - name: Post test results comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // æœ€æ–°ã®ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
            const testResultsDir = path.join(process.env.GITHUB_WORKSPACE, 'docs/test_results');
            let files = [];
            try {
              files = fs.readdirSync(testResultsDir)
                .filter(file => file.startsWith('test_result_'))
                .sort()
                .reverse();
            } catch (error) {
              console.log(`Error reading test results directory: ${error.message}`);
              return;
            }
              
            if (files.length === 0) {
              console.log('No test result files found');
              return;
            }
            
            const latestFile = path.join(testResultsDir, files[0]);
            const testResults = fs.readFileSync(latestFile, 'utf8');
            
            // ãƒ†ã‚¹ãƒˆçµæœã®æ¦‚è¦ã‚’æŠ½å‡º
            const lines = testResults.split('\n');
            const summary = lines
              .filter(line => 
                line.includes('test cases') || 
                line.includes('assertions') || 
                line.includes('ãƒ†ã‚¹ãƒˆçµæœ:') ||
                line.includes('OSC Bridge') ||
                line.includes('æˆåŠŸ') || 
                line.includes('å¤±æ•—')
              )
              .join('\n');
            
            // PRç•ªå·ã®å–å¾—
            const prNumber = context.issue.number;
            
            // ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## OSC Bridge Test Results on ${{ matrix.os }}\n\n### ãƒ†ã‚¹ãƒˆçµæœæ¦‚è¦\n- å¾“æ¥ã®ãƒ†ã‚¹ãƒˆ (Min-DevKitä¾å­˜): ${{ steps.legacy_tests.outcome == 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—' }}\n- ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ†ã‚¹ãƒˆ (Min-DevKitéä¾å­˜): ${{ steps.standalone_tests.outcome == 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—' }}\n\n\`\`\`\n${summary}\n\`\`\`\n\nè©³ç´°ã¯æ·»ä»˜ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`
            });
