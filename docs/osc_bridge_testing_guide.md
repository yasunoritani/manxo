# OSC Bridge テスト・検証ガイド

**バージョン:** 1.0.0  
**最終更新:** 2025-03-30  
**対象アーキテクチャ:** Intel (x86_64) および Apple Silicon (arm64)  
**互換性:** Max/MSP 8.0.2, 8.1.0, 8.2.0  
**作成者:** v8ui開発チーム  

---

## 目次

1. [はじめに](#はじめに)
2. [テスト環境の前提条件](#テスト環境の前提条件)
3. [アーキテクチャ互換性の検証](#アーキテクチャ互換性の検証)
4. [Max/MSP各バージョンでの検証](#maxmsp各バージョンでの検証)
5. [実際のテストパッチ](#実際のテストパッチ)
   - [基本機能テスト](#基本機能テスト)
   - [エラー回復テスト](#エラー回復テスト)
   - [性能テスト](#性能テスト)
   - [マルチインスタンステスト](#マルチインスタンステスト)
   - [M4Lライフサイクルテスト](#m4lライフサイクルテスト)
6. [問題が発生した場合の対処法](#問題が発生した場合の対処法)
7. [テスト結果の報告](#テスト結果の報告)
8. [付録](#付録)

---

## はじめに

このドキュメントは、OSC Bridge（`osc_bridge.mxo`）の互換性と機能性を様々な環境で検証するための包括的なガイドです。Max/MSP環境での運用を開始する前に、このテスト手順に従って、お使いの環境での互換性と機能を確認してください。

OSC Bridgeはx86_64（Intel Mac）とarm64（Apple Silicon Mac）の両方のアーキテクチャをサポートするユニバーサルバイナリとして構築されています。また、Max/MSP 8.0.2から8.2.0までの互換性を確保しています。

---

## テスト環境の前提条件

### ソフトウェア要件

- **Max/MSP:** バージョン8.0.2、8.1.0、または8.2.0
  - 少なくとも1つのバージョンがインストールされていること（すべての互換性を検証するには、すべてのバージョンが必要）
- **macOS:** バージョン10.13（High Sierra）以降
  - 推奨: macOS 12.0（Monterey）以降

### ハードウェア構成（理想的なテスト環境）

以下の環境がある場合、それぞれでテストを実施することを推奨します：

1. **Intel Mac**（x86_64アーキテクチャネイティブ実行）
2. **Apple Silicon Mac**（arm64アーキテクチャネイティブ実行）
3. **Apple Silicon Mac上のRosetta 2**（x86_64アーキテクチャエミュレーション）

### 必要なファイル

- `osc_bridge.mxo` - テスト対象のMax外部オブジェクト
- テスト用Maxパッチ - `/src/min-devkit/osc_bridge/m4l-patches/`内のファイル
- 検証スクリプト - `/src/min-devkit/osc_bridge/verify_architecture.sh`

---

## アーキテクチャ互換性の検証

### 事前検証（ターミナル）

最初に、OSC Bridgeが両方のアーキテクチャをサポートするユニバーサルバイナリであることを確認します。

1. ターミナルを開きます
2. 検証スクリプトを実行します:

```bash
cd /Users/mymac/v8ui/src/min-devkit/osc_bridge
./verify_architecture.sh
```

スクリプトは以下を確認します:
- `osc_bridge.mxo`がarm64とx86_64の両方のアーキテクチャをサポートしていること
- デプロイメントターゲットがmacOS 10.13であること（Max 8.0.2+互換性のため）
- 依存関係が正しくリンクされていること

成功すると、次のような出力が表示されます:
```
✓ OSC Bridge はユニバーサルバイナリとして正しく構築されています (arm64 + x86_64)
✓ デプロイメントターゲットは正しく macOS 10.13 に設定されています
```

### 手動検証（ターミナル）

より詳細な検証が必要な場合は、以下のコマンドを実行します：

```bash
# バイナリ情報の詳細表示
file /Users/mymac/v8ui/externals/osc_bridge.mxo/Contents/MacOS/osc_bridge

# デプロイメントターゲットの確認
otool -l /Users/mymac/v8ui/externals/osc_bridge.mxo/Contents/MacOS/osc_bridge | grep -A 4 LC_VERSION_MIN

# 依存関係の確認
otool -L /Users/mymac/v8ui/externals/osc_bridge.mxo/Contents/MacOS/osc_bridge
```

---

## Max/MSP各バージョンでの検証

### 検証環境の準備

1. テスト対象のMax/MSPバージョンをインストールします（8.0.2、8.1.0、8.2.0）
2. Maxアプリケーションを起動します
3. `Options > File Preferences`を開きます
4. `osc_bridge.mxo`の場所を確認または追加します:
   - 通常は `/Users/mymac/v8ui/externals/` をパスに追加します
   - または `~/Max 8/Packages/` ディレクトリに `osc_bridge.mxo` をコピーします

### 各バージョンでのテスト実行

1. Max/MSP 8.0.2でのテスト
   - 基本機能テストパッチを開きます
   - すべての機能が正常に動作することを確認します
   - エラーや警告メッセージがないことを確認します

2. Max/MSP 8.1.0でのテスト
   - 同様の手順でテストを実行します

3. Max/MSP 8.2.0でのテスト
   - 同様の手順でテストを実行します

### Rosetta 2モードでのテスト（Apple Silicon Macのみ）

Apple Silicon Mac（M1/M2/M3チップ搭載）でIntel版Maxを実行する場合：

1. FinderでMax/MSPアプリケーションを選択します
2. 「情報を見る」を選択します
3. 「Rosettaを使用して開く」オプションをチェックします
4. Maxを再起動し、同じテストを実行します

---

## 実際のテストパッチ

### 基本機能テスト

基本機能テストパッチ（`osc_bridge_basic_test.maxpat`）を開き、以下の機能をテストします：

1. **OSC送信テスト**
   - テストパッチの「Send Test」ボタンをクリックします
   - 成功するとメッセージボックスに「Sent successfully」と表示されます

2. **OSC受信テスト**
   - 「Start Receiving」ボタンをクリックしてリスニングを開始します
   - テストメッセージを送信します（内部ループバック設定済み）
   - 成功するとメッセージボックスに受信したデータが表示されます

3. **データ型テスト**
   - 整数、浮動小数点、文字列、ブーリアン型のテスト
   - 各データ型の「Test」ボタンをクリックします
   - 対応するデータ型が正しく送受信されることを確認します

### エラー回復テスト

エラー回復テストパッチ（`osc_bridge_error_recovery_test.maxpat`）を使用して、エラー状態からの回復をテストします：

1. **接続喪失シミュレーション**
   - 「Simulate Network Failure」ボタンをクリックします
   - OSCブリッジが「Connection Lost」状態を報告することを確認します
   - 「Restore Connection」ボタンをクリックします
   - 接続が数秒以内に自動的に回復することを確認します

2. **無効なアドレスパターンテスト**
   - 「Send Invalid Pattern」ボタンをクリックします
   - エラーが適切に処理され、クラッシュが発生しないことを確認します

### 性能テスト

性能テストパッチ（`osc_bridge_performance_test.maxpat`）を使用して、パフォーマンスを検証します：

1. **スループットテスト**
   - 「Start Throughput Test」ボタンをクリックします
   - 10秒間のメッセージ送信レートを測定します
   - 結果が表示されます（メッセージ/秒）
   - 最低500メッセージ/秒のスループットを確認します

2. **レイテンシテスト**
   - 「Start Latency Test」ボタンをクリックします
   - ループバック経由で往復時間を測定します
   - 平均レイテンシが2ms未満であることを確認します

### マルチインスタンステスト

マルチインスタンステストパッチ（`osc_bridge_multi_instance_test.maxpat`）を使用して、複数のOSC Bridgeオブジェクトの共存をテストします：

1. **同時複数インスタンス**
   - テストパッチを開くと、3つのOSC Bridgeインスタンスが作成されます
   - 各インスタンスが異なるポートを使用していることを確認します
   - 各インスタンスの「Test」ボタンをクリックします
   - すべてのインスタンスが独立して動作することを確認します

2. **ポート競合解決**
   - 「Force Port Conflict」ボタンをクリックします
   - OSC Bridgeが自動的に別のポートを選択することを確認します
   - 競合後も機能が正常に動作することを確認します

### M4Lライフサイクルテスト

M4Lライフサイクルテストパッチ（`osc_bridge_m4l_lifecycle_test.amxd`）を使用して、Max for Live環境でのライフサイクル管理をテストします：

1. **M4Lライフサイクルイベント**
   - テストパッチをAbleton Live内で開きます
   - 「Simulate Liveset Events」セクションの各ボタンをクリックします:
     - `liveset_new`
     - `liveset_loaded`
     - `liveset_saved`
     - `liveset_closed`
   - 各イベント後にOSC Bridgeが正しく状態を維持または再初期化することを確認します

2. **セッション間の持続性**
   - Liveセットを保存して閉じます
   - 保存したLiveセットを再度開きます
   - OSC Bridgeが正しく再初期化されることを確認します

---

## 問題が発生した場合の対処法

テスト中に問題が発生した場合、以下の手順で対処してください：

### 問題の特定

1. **エラーメッセージを確認**
   - Max/MSPコンソールに表示されるエラーメッセージを記録します
   - 特定のアーキテクチャでのみ発生する問題かを確認します

2. **ログの収集**
   - Max/MSPコンソールの内容をコピーします（Max > Window > Max Console）
   - ターミナルから `verify_architecture.sh` の出力を記録します

### 一般的な問題の解決

#### 「osc_bridge.mxo not found」エラー

1. Max検索パスにexternalsディレクトリが追加されているか確認します
2. 必要に応じて手動で `osc_bridge.mxo` を `~/Max 8/Packages/` にコピーします

#### パフォーマンスの問題

1. CPU使用率を確認します（Activity Monitor）
2. テスト中の他のネットワークトラフィックを最小限に抑えます
3. Rosetta 2モードで実行している場合、ネイティブモードと比較します

#### ポート競合の問題

1. 他のOSCアプリケーションを終了します
2. ファイアウォール設定を確認します
3. テストパッチで使用するポート番号を変更します（デフォルト: 7400）

---

## テスト結果の報告

テスト結果を記録し、開発チームと共有することで、OSC Bridgeの改善に貢献できます。以下の情報を含めてください：

### 環境情報

1. macOSバージョン: 例）macOS 13.4 (Ventura)
2. Macハードウェア: 例）MacBook Pro 14" (M2 Pro)
3. アーキテクチャ: arm64 / x86_64 / Rosetta 2
4. Max/MSPバージョン: 例）Max 8.2.0
5. OSC Bridgeバージョン: 例）1.0.0

### テスト結果サマリー

各テストカテゴリの結果を簡潔に記述します：

```
1. 基本機能テスト: 成功 / 一部成功 / 失敗
2. エラー回復テスト: 成功 / 一部成功 / 失敗
3. 性能テスト: 
   - スループット: XXX メッセージ/秒
   - レイテンシ: XX ms
4. マルチインスタンステスト: 成功 / 一部成功 / 失敗
5. M4Lライフサイクルテスト: 成功 / 一部成功 / 失敗
```

### 詳細な問題報告

問題が発生した場合は、以下の詳細を記録します：

1. 問題の正確な手順（再現可能なステップ）
2. 観察された動作
3. 期待された動作
4. エラーメッセージやログの関連部分
5. 問題の緊急度 (低/中/高)

---

## 付録

### OSC Bridgeパラメータリファレンス

OSC Bridgeオブジェクトは、以下のパラメータをサポートしています：

| パラメータ | 説明 | デフォルト値 |
|------------|------|-------------|
| @host | 接続先ホスト名またはIPアドレス | "127.0.0.1" |
| @port | 接続先ポート番号 | 7400 |
| @local_port | ローカルリスニングポート番号 | 7500 |
| @dynamic_ports | 動的ポート割り当ての有効化 | 1 (有効) |
| @reconnect | 自動再接続の有効化 | 1 (有効) |
| @buffer_size | OSCメッセージバッファサイズ (バイト) | 65536 |

### データ型サポート

OSC Bridgeは以下のOSCデータ型をサポートしています：

| OSC型 | Max/MSP表現 |
|-------|------------|
| int32 | 整数 |
| float32 | 浮動小数点数 |
| string | シンボルまたは文字列 |
| blob | リスト |
| boolean (T/F) | 1/0 |
| nil | "nil"シンボル |
| infinitum | "inf"シンボル |

### アーキテクチャ判別方法

現在のMaxが実行されているアーキテクチャを確認するには、以下のMaxパッチコードを使用できます：

```
[max getsystem]
|
[route architecture]
|
[print Architecture]
```

### テスト自動化スクリプト

高度なテスト自動化のために、`osc_bridge_automated_test.js`スクリプトを使用できます。このスクリプトは、すべてのテストケースを自動的に実行し、結果を報告します。

```javascript
// Maxコンソールで実行：
// node osc_bridge_automated_test.js
```

---

**注意:** このテストガイドは、OSC Bridgeの機能とアーキテクチャ互換性を検証するためのものです。実際の使用環境に応じて、追加のテストが必要になる場合があります。特にライブパフォーマンスで使用する前には、実際の使用条件に合わせた総合的なテストを行ってください。

---

© 2025 v8ui開発チーム | すべての権利を留保します
