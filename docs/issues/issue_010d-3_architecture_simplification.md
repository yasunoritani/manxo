# Issue #010d-3: MCPアーキテクチャ簡素化とコード品質向上

**ステータス**: 提案
**種別**: リファクタリング
**優先度**: 高
**担当者**: 未割り当て
**リポート日**: 2025-04-10
**親Issue**: #010d

## 概要

現在のClaude AI統合モジュール（`integration.js`）の実装には、MCPプロトコルの本質を理解せず、不要な冗長性や複雑さが含まれています。このissueは、MCPプロトコルを正しく理解し、アーキテクチャを簡素化することで、より堅牢で保守性の高いコードベースを実現することを目的とします。

## 現状の問題点

1. **プロトコル理解の誤り**:
   - MCPプロトコル自体が持つエラーハンドリング・バリデーション機能を認識せず、重複した処理を実装
   - プロトコルの基本設計思想に反した複雑な層の追加

2. **冗長なエラーハンドリング**:
   - MCPがすでに提供する入力検証を二重に実装
   - プロトコルレベルのエラー処理と重複するtry-catch構造

3. **不要なタイムアウト処理**:
   - MCPプロトコルが内蔵するタイムアウト機能を無視した独自実装
   - 重複するタイムアウト管理コード（`_executeWithTimeout`メソッド）

4. **過剰なリトライロジック**:
   - 基本的には一度で成功するMCP接続に対する複雑なリトライループ
   - 状態管理の複雑化をもたらすコード

5. **コード変換の混乱**:
   - JavaScript/C++間の変換に関する誤解
   - 不明確な要件による追加複雑性

## 目標

1. MCPプロトコルの本質を理解し、そのデザインパターンに準拠した実装に修正
2. 冗長なエラーハンドリングを削除し、MCPの内蔵機能を最大限に活用
3. 不要なタイムアウト処理やリトライロジックを簡素化または削除
4. JavaScript/C++変換に関する混乱を解消し、明確なアプローチを確立
5. コード量を30%以上削減しつつ、同等以上の安定性を実現

## 詳細仕様

### MCPプロトコル活用

1. **プロトコル機能の正しい理解**:
   - JSONスキーマによる入力バリデーションの活用
   - ツール実行時のエラーハンドリング機能の適切な使用
   - タイムアウト管理の委譲

2. **シンプルなツール実装**:
   ```javascript
   this.mcpServer.registerTool({
     name: 'validateCode',
     inputJsonSchema: { /* スキーマ定義 */ },
     execute: async ({ code, context = '' }) => {
       // ValidationEngineの実行のみ（追加の検証なし）
       const result = await this.validationEngine.validateCode(code, context);
       return { content: JSON.stringify(result) };
     }
   });
   ```

### エラーハンドリングの簡素化

1. **入力検証の削除**:
   - JSONスキーマが保証する検証をコード内で重複して行わない
   - 必須パラメータチェックの除去

2. **例外処理の最適化**:
   - 本当に必要な箇所のみにtry-catchを残す
   - グローバルなエラーハンドリングの活用

### タイムアウト管理の委譲

1. **`_executeWithTimeout`メソッドの削除**:
   - MCPプロトコルのタイムアウト機能の活用
   - ツール実行時のタイムアウト指定による管理

2. **初期化プロセスの簡素化**:
   - 複雑なAbortControllerロジックの削除
   - シンプルな初期化フローの実装

### リトライロジックの簡素化

1. **シンプルな接続処理**:
   - 複雑なリトライループの削除
   - 必要な場合のみの単純なフォールバック

### コード変換の明確化

1. **アプローチの再定義**:
   - JavaScript/C++変換の目的と範囲の明確化
   - 直接C++生成へのアプローチシフト検討

## 実装計画

1. MCPプロトコルの再調査とベストプラクティス把握 (1日)
2. 冗長なエラーハンドリングの特定と削除 (2日)
3. タイムアウトとリトライロジックの簡素化 (1日)
4. コード変換アプローチの明確化と実装 (2日)
5. テストと検証 (1日)

## 関連Issue

- 親Issue: #010d SQL知識ベースの検証エンジンの開発
- 関連Issue: #010d-2 Claude AI統合モジュールの堅牢化と品質向上

## 参考資料

1. [MCPプロトコル公式仕様](https://github.com/anthropics/anthropic-cookbook/tree/main/model_context_protocol)
2. [MCPベストプラクティス](https://docs.anthropic.com/claude/docs/model-context-protocol)
3. [JavaScript/C++相互運用パターン](https://nodejs.org/api/addons.html)
4. [リファクタリングパターン](https://refactoring.com/catalog/)
