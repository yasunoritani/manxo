# Min-DevKit中心設計：Max技術連携アーキテクチャ

## 基本設計思想

Min-DevKitを中心とした実装を基盤とし、v8uiとnode.scriptへの連携を選択的に構築する設計方針。これにより、各技術の強みを活かしつつ、互換性と拡張性を両立する。

## 技術的背景

- **Min-DevKit**: 公式にはMax 8.2までの対応（C++実装）
- **v8ui**: Max 9から導入されたJavaScript実行環境
- **node.script**: Maxに組み込まれたNode.js実行環境（制限あり）
- **Node.js**: 独立プロセスとして実行されるサーバー環境

## アーキテクチャ概要

```
[Min-DevKit C++ 実装] <- コア機能（必須）
        ↑↓
    [OSCブリッジ]
        ↑↓
[外部連携レイヤー] <- オプション機能
```

## 各技術の位置づけと連携方法

### 1. Min-DevKit (C++)

- **役割**: コア機能実装、パフォーマンスクリティカルな処理
- **強み**: 
  - ネイティブコードによる高速処理
  - 静的型付けによる安全性
  - Max内部APIへの直接アクセス
- **対応バージョン**: Max 7および8.2以下（公式サポート）
- **実装優先度**: 最優先

### 2. v8ui連携 (JavaScript)

- **役割**: 高度なUI機能、動的なコード生成
- **強み**:
  - 柔軟なUI処理
  - JavaScriptエコシステムの活用
  - 動的なコード実行
- **連携方法**:
  - OSCプロトコルまたはMax内部メッセージ
  - C++からのコールバック登録
- **対応バージョン**: Max 9以降のみ
- **実装優先度**: 3番目（オプション機能）

### 3. node.script連携

- **役割**: 制限されたNode.js機能、シンプルなブリッジ
- **強み**:
  - Max内部での簡易的なNode.js処理
  - 低オーバーヘッドの連携
- **連携方法**:
  - Maxメッセージパッシング
  - シンプルなデータ構造での通信
- **実装優先度**: オプション（最小限の利用）

### 4. 外部Node.js連携

- **役割**: MCP通信、外部API連携、複雑な非同期処理
- **強み**:
  - 独立プロセスによる安定性
  - フルNode.js環境の活用
  - npmエコシステムへのアクセス
- **連携方法**:
  - OSCプロトコル（UDP/TCP）
  - 明確に定義されたAPIインターフェース
- **実装優先度**: 2番目

## 実装アプローチ

### フェーズ1: Min-DevKit OSCブリッジ実装
- C++によるOSCクライアント・サーバークラス
- 基本的なメッセージング機能
- エラーハンドリングとリカバリー

### フェーズ2: 外部Node.js連携
- OSCベースのMCPサーバー連携
- イベント駆動型通信設計
- セキュアな通信チャネル

### フェーズ3: v8ui連携（オプション）
- Max 9環境向け拡張機能
- JavaScriptとC++間のデータ変換
- 条件付きコンパイルによる互換性確保

## 技術選択の判断基準

1. **パフォーマンス要件**:
   - 50ms以下の応答が必要 → C++
   - 非リアルタイム処理 → Node.js/JavaScript

2. **開発効率**:
   - 迅速な開発が必要 → JavaScript
   - 堅牢性が最重要 → C++

3. **対応バージョン**:
   - Max 8.2以下も対象 → Min-DevKitのみ
   - Max 9のみ対象 → v8ui連携も活用

## 注意点と課題

1. **バージョン互換性**:
   - Min-DevKitのMax 9での非公式サポート状況確認
   - 条件付きコンパイルによる互換性確保

2. **技術間の明確な境界**:
   - 責任範囲を明確に分離
   - 明示的なインターフェース定義

3. **エラー分離**:
   - 各技術の障害が他に波及しない設計
   - 適切なフォールバック機構

## 実装計画

1. **Core OSC Bridge (Min-DevKit C++)**:
   - `mcp.osc_types.hpp`: 型・構造体定義
   - `mcp.osc_client.cpp`: 送信機能
   - `mcp.osc_server.cpp`: 受信処理
   - `mcp.osc_bridge.cpp`: 統合インターフェース

2. **Node.js連携 (オプション)**:
   - OSCアドレスパターン定義
   - メッセージフォーマット仕様
   - エラーハンドリングプロトコル

3. **v8ui連携 (オプション/Max 9のみ)**:
   - JavaScriptブリッジインターフェース
   - イベント連携メカニズム

## 依存関係管理

- **必須依存**:
  - Min-DevKit
  - oscpack (または同等のOSCライブラリ)
  - CMake 3.19以上
  - C++17対応コンパイラ

- **オプション依存**:
  - Node.js (外部連携用)
  - Max 9 (v8ui連携用)
