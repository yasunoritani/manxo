# Max 9 - Claude Desktop 通信プロトコル仕様

## 概要

本ドキュメントでは、Max 9とClaude Desktop間のMCP連携における通信プロトコルとメッセージング仕様を定義します。この仕様は、MCPサーバーとMax OSCブリッジ間の一貫性のある通信を保証し、拡張性と堅牢性を確保することを目的としています。

## 1. アドレスパターン標準化

OSCメッセージは以下のアドレスパターン形式に従います：

### MCPサーバーからMax 9への通信
```
/mcp/[カテゴリ]/[アクション] [引数1] [引数2] ...
```

### Max 9からMCPサーバーへの通信
```
/max/[カテゴリ]/[アクション] [引数1] [引数2] ...
```

### 標準カテゴリ

| カテゴリ | 説明 |
|----------|------|
| `patch` | パッチ関連操作（作成、保存、読み込み等） |
| `object` | オブジェクト関連操作（作成、削除、接続等） |
| `param` | パラメータ関連操作（設定、取得等） |
| `system` | システム関連操作（初期化、終了等） |
| `response` | 操作結果の応答 |
| `error` | エラー通知 |
| `state` | 状態通知 |

## 2. パラメータフォーマット

パラメータは以下の形式でOSCメッセージに含めます：

### 基本型
- 整数: そのまま渡す（例: `42`）
- 浮動小数点数: そのまま渡す（例: `3.14`）
- 文字列: 引用符なしで渡す（例: `hello`）
- ブール値: `0`（偽）または`1`（真）として渡す

### 複合型
- 配列: JSONシリアライズされた文字列（例: `[1,2,3]`）
- オブジェクト: JSONシリアライズされた文字列（例: `{"key":"value"}`）

### 特殊パラメータ
- `id`: 操作を識別するためのユニークID（UUID形式推奨）
- `timestamp`: 操作発生時のタイムスタンプ（ミリ秒単位のUNIXタイムスタンプ）

## 3. 標準アクション定義

### パッチ操作
| アクション | 説明 | 形式 |
|------------|------|------|
| `create` | 新しいパッチの作成 | `/mcp/patch/create [name] [template?]` |
| `open` | 既存パッチの読み込み | `/mcp/patch/open [path]` |
| `save` | パッチの保存 | `/mcp/patch/save [path?]` |
| `close` | パッチの閉じる | `/mcp/patch/close [id]` |

### オブジェクト操作
| アクション | 説明 | 形式 |
|------------|------|------|
| `create` | オブジェクト作成 | `/mcp/object/create [type] [x] [y] [args?]` |
| `delete` | オブジェクト削除 | `/mcp/object/delete [id]` |
| `connect` | オブジェクト接続 | `/mcp/object/connect [src_id] [src_outlet] [dst_id] [dst_inlet]` |
| `disconnect` | 接続解除 | `/mcp/object/disconnect [src_id] [src_outlet] [dst_id] [dst_inlet]` |
| `move` | オブジェクト移動 | `/mcp/object/move [id] [x] [y]` |

### パラメータ操作
| アクション | 説明 | 形式 |
|------------|------|------|
| `set` | パラメータ設定 | `/mcp/param/set [id] [param_name] [value]` |
| `get` | パラメータ取得 | `/mcp/param/get [id] [param_name]` |
| `watch` | パラメータ監視 | `/mcp/param/watch [id] [param_name]` |
| `unwatch` | 監視解除 | `/mcp/param/unwatch [id] [param_name]` |

### システム操作
| アクション | 説明 | 形式 |
|------------|------|------|
| `init` | システム初期化 | `/mcp/system/init [config?]` |
| `shutdown` | システム終了 | `/mcp/system/shutdown` |
| `status` | システム状態取得 | `/mcp/system/status` |
| `ping` | 接続確認 | `/mcp/system/ping [timestamp]` |

## 4. レスポンス形式

操作の結果は以下の形式で返されます：

### 成功レスポンス
```
/max/response/[カテゴリ]/[アクション] [request_id] [結果データ]
```

### エラーレスポンス
```
/max/error/[カテゴリ]/[アクション] [request_id] [エラーコード] [エラーメッセージ]
```

## 5. エラー通知プロトコル

エラーコードは以下のカテゴリに分類されます：

| エラーコード範囲 | カテゴリ | 説明 |
|------------------|----------|------|
| 100-199 | 通信エラー | OSC通信に関するエラー |
| 200-299 | パッチエラー | パッチ操作に関するエラー |
| 300-399 | オブジェクトエラー | オブジェクト操作に関するエラー |
| 400-499 | パラメータエラー | パラメータ操作に関するエラー |
| 500-599 | システムエラー | システム全般に関するエラー |

詳細なエラーコードリストは`ERROR_CODES.md`を参照してください。

## 6. 状態同期プロトコル

Max 9とMCPサーバー間の状態同期は以下のメカニズムで行います：

### 状態変更通知
```
/max/state/[カテゴリ]/[オブジェクト] [id] [変更内容]
```

### 状態同期要求
```
/mcp/state/sync [target_category?] [target_id?]
```

### 状態同期レスポンス
```
/max/state/sync/response [request_id] [状態データ]
```

## 7. セッション管理

セッション管理は以下のプロトコルで行います：

### セッション開始
```
/mcp/session/start [session_id] [config?]
```

### セッション終了
```
/mcp/session/end [session_id]
```

### セッション状態保存
```
/mcp/session/save [session_id] [path?]
```

### セッション状態読み込み
```
/mcp/session/load [path]
```

## 8. 拡張性

プロトコルの拡張は以下の命名規則に従って行います：

- 標準仕様との互換性を維持すること
- カスタムカテゴリは `x-` プレフィックスを使用する（例: `/mcp/x-midi/...`）
- カスタムアクションは既存カテゴリ内で定義する場合、標準アクションと衝突しないようにする

## 9. 実装要件

実装は以下の要件を満たす必要があります：

- OSCメッセージのバリデーション
- エラー時の適切なエラーレスポンス
- タイムアウト処理
- 再接続メカニズム
- デバッグモード（詳細ログ出力）