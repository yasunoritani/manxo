# Max 8 - Claude Desktop 状態同期プロトコル仕様

## 概要

本ドキュメントでは、Max 8とClaude Desktop MCPサーバー間の状態同期プロトコルを詳細に定義します。このプロトコルは、Max 8の現在の状態をMCPサーバーに反映し、一貫性のある操作を可能にします。

## 1. 状態モデル

Max 8の状態は以下の階層構造でモデル化されます：

```
Session
  |
  +--- Patches[]
        |
        +--- Objects[]
              |
              +--- Parameters[]
        |
        +--- Connections[]
  |
  +--- GlobalSettings
```

### 1.1 状態オブジェクト定義

#### セッション
セッション全体を表すルートオブジェクトです。
```json
{
  "id": "session-uuid",
  "name": "セッション名",
  "startTime": 1648123456789,
  "patches": [...],
  "globalSettings": {...}
}
```

#### パッチ
Max 8パッチを表すオブジェクトです。
```json
{
  "id": "patch-uuid",
  "name": "パッチ名",
  "path": "ファイルパス",
  "isModified": false,
  "objects": [...],
  "connections": [...]
}
```

#### オブジェクト
Max 8パッチ内のオブジェクトを表します。
```json
{
  "id": "object-uuid",
  "type": "オブジェクトタイプ",
  "position": {"x": 100, "y": 150},
  "size": {"width": 80, "height": 22},
  "parameters": [...],
  "inlets": [...],
  "outlets": [...]
}
```

#### パラメータ
オブジェクトのパラメータ（属性）を表します。
```json
{
  "name": "パラメータ名",
  "value": "パラメータ値",
  "type": "データ型",
  "isReadOnly": false
}
```

#### 接続
オブジェクト間の接続を表します。
```json
{
  "id": "connection-uuid",
  "sourceId": "source-object-uuid",
  "sourceOutlet": 0,
  "destinationId": "destination-object-uuid",
  "destinationInlet": 0
}
```

#### グローバル設定
セッション全体に適用される設定です。
```json
{
  "oscPort": 7400,
  "sampling_rate": 44100,
  "audioDriver": "CoreAudio",
  // ...その他の設定
}
```

## 2. 状態同期メカニズム

### 2.1 イベントベース同期

状態の変化は、発生したイベントに基づいて同期されます。以下のイベントタイプが定義されています：

| イベントタイプ | 説明 |
|--------------|------|
| `created` | オブジェクトが作成された |
| `updated` | オブジェクトが更新された |
| `deleted` | オブジェクトが削除された |
| `connected` | オブジェクト間が接続された |
| `disconnected` | オブジェクト間の接続が解除された |
| `moved` | オブジェクトが移動した |
| `resized` | オブジェクトがリサイズされた |
| `paramChanged` | パラメータが変更された |
| `stateChanged` | 複数の変更を含む状態変更 |

### 2.2 状態変更通知

Max 8での状態変更はMCPサーバーに以下の形式で通知されます：

```
/max/state/[カテゴリ]/[イベントタイプ] [オブジェクトID] [変更データJSON]
```

**例**:
```
/max/state/object/created obj-123 {"type":"slider","position":{"x":100,"y":150}}
```

### 2.3 状態同期リクエスト

MCPサーバーはMax 8の現在の状態を以下の形式で要求できます：

```
/mcp/state/sync [リクエストID] [対象カテゴリ(オプション)] [対象ID(オプション)]
```

**例**:
```
/mcp/state/sync req-456 patch patch-789  // 特定のパッチの状態をリクエスト
/mcp/state/sync req-457                   // セッション全体の状態をリクエスト
```

### 2.4 状態同期レスポンス

Max 8は状態同期リクエストに対して以下の形式でレスポンスします：

```
/max/state/sync/response [リクエストID] [状態データJSON]
```

## 3. 差分同期

効率的な通信のため、完全な状態ではなく差分のみを送信する方法も提供します。

### 3.1 差分形式

差分は以下の形式で表されます：

```json
{
  "op": "操作タイプ",  // "add", "replace", "remove", "move"のいずれか
  "path": "JSONパス",  // 例: "/patches/0/objects/3/parameters/gain"
  "value": "新しい値"   // "remove"操作の場合は不要
}
```

### 3.2 差分同期要求

```
/mcp/state/diff/sync [リクエストID] [最後の同期時刻]
```

### 3.3 差分同期レスポンス

```
/max/state/diff/sync/response [リクエストID] [差分データJSON配列]
```

## 4. 状態の永続化

### 4.1 状態の保存

現在の状態を永続化するためのリクエスト：

```
/mcp/state/save [リクエストID] [保存先パス(オプション)]
```

### 4.2 状態の読み込み

保存された状態を読み込むためのリクエスト：

```
/mcp/state/load [リクエストID] [読み込み元パス]
```

## 5. コンフリクト解決

同時に複数の変更が発生した場合のコンフリクト解決戦略：

### 5.1 タイムスタンプベース

各変更にはタイムスタンプが付加され、より新しい変更が優先されます。

### 5.2 優先度ベース

変更元に優先度を設定し、優先度の高いソースからの変更が優先されます。デフォルトの優先度は：

1. ユーザーによる直接操作（Max UI）
2. MCPサーバーからの操作
3. その他の自動処理

### 5.3 マージ戦略

競合する変更を検出した場合、可能であれば変更をマージします。マージできない場合は5.1か5.2のルールを適用します。

## 6. 実装要件

状態同期プロトコルを実装する際の要件：

### 6.1 Max OSCブリッジ側

- 状態変更の検出と通知機能
- 状態同期リクエストの処理
- 現在の状態のシリアライズ
- 差分計算と適用
- エラー処理とリカバリー

### 6.2 MCPサーバー側

- 状態モデルの維持
- 状態変更通知の処理
- 状態同期リクエストの発行
- 差分の計算と適用
- 状態の永続化と読み込み

## 7. 状態同期の最適化

### 7.1 部分同期

大規模パッチの場合、必要な部分のみを同期することで効率化します：

```
/mcp/state/sync req-458 object obj-123  // 特定のオブジェクトのみ同期
```

### 7.2 ポーリング頻度の調整

状態変更の頻度に応じて同期頻度を動的に調整します：

```
/mcp/state/poll/configure [ポーリング間隔ms] [対象カテゴリ]
```

### 7.3 バッチ処理

短時間に多数の変更が発生する場合（例：複数オブジェクトのドラッグ移動）、変更をバッチ処理して効率化します：

```
/max/state/batch/begin [バッチID]
// 複数の状態変更通知
/max/state/batch/end [バッチID]
```

## 8. エラー処理

状態同期中に発生するエラーの処理：

### 8.1 同期エラー通知

```
/max/error/state/sync [リクエストID] [エラーコード] [エラーメッセージ]
```

### 8.2 再同期メカニズム

同期エラーが発生した場合、以下のリクエストで完全再同期を要求できます：

```
/mcp/state/resync [リクエストID]
```

## 9. デバッグとモニタリング

### 9.1 同期ステータスリクエスト

```
/mcp/state/status [リクエストID]
```

### 9.2 同期ステータスレスポンス

```
/max/state/status/response [リクエストID] [同期ステータスJSON]
```

### 9.3 デバッグモード

デバッグ情報を含む詳細な同期ログを有効にします：

```
/mcp/state/debug [0|1]
```
