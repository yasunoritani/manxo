# Manxoプロジェクト - 実装状況と次のステップ
（最終更新: 2023年12月）

## カテゴリ別ステータス

### 1. MCPサーバー
**完了した項目** ✅
- 基本的なMCPサーバー構造の実装
- OSCクライアントの実装
- Max接続機能のテスト
- 統合データアクセスアーキテクチャの実装
- 一貫性のあるエラー処理パターンの確立

**進行中** 🔄
- エラーハンドリングの強化

**次のステップ** 📝
- 追加プロトコル対応
- パフォーマンスモニタリング機能

### 2. 分散型データベース
**完了した項目** ✅
- SQLiteからのデータ抽出
- ベクトルDB実装（完全ローカル実装）
- グラフDB実装
- ドキュメントDB実装
- 移行結果の検証
- SQL依存からの完全移行
- データアクセス関数の統合と標準化

**進行中** 🔄
- パフォーマンス最適化

**次のステップ** 📝
- インデックス最適化
- バックアップと復旧手順の確立

### 3. ベクトル検索
**完了した項目** ✅
- キャッシュ機構の実装
- 完全ローカル設計の確立
- セマンティック検索パイプライン
- 統一APIによるアクセス簡素化

**進行中** 🔄
- 検索速度の向上
- 基本的な最適化

**次のステップ** 📝
- 大規模データセット対応
- 高度なインデックス構造の導入

### 4. AI駆動型パッチジェネレーター
**完了した項目** ✅
- 自然言語からのパッチ生成機能
- テンプレートベースの生成システム
- オーディオ・ビデオ処理向けテンプレート作成

**進行中** 🔄
- テンプレートの拡充

**次のステップ** 📝
- 大規模パッチ生成時のメモリ最適化
- テンプレートファイルの存在確認ロジック追加

### 5. MCP連携機能
**完了した項目** ✅
- 基本構造の実装
- 完全ローカル通信プロトコルの確立
- 外部APIキー不使用の原則確立
- 統合インターフェースによるツール登録の簡素化
- 一貫したエラー処理とレスポンス形式の統一

**進行中** 🔄
- 分散型DBとMCPの接続の強化
- データ連携の最適化

**次のステップ** 📝
- クエリルーティングシステムの構築
- クエリ結果の整形機能の強化
- Claude Desktopとの通信連携の改善

### 6. クロスプラットフォーム
**完了した項目** ✅
- macOS基本対応

**進行中** 🔄
- macOS環境での動作検証
- 環境検出機能の実装

**次のステップ** 📝
- Windows対応計画
- 環境固有の依存関係管理

### 7. セキュリティ
**完了した項目** ✅
- パス検証の実装
- 基本的な入力検証
- ツール入力パラメータの厳格な検証

**進行中** 🔄
- 入力検証の拡充

**次のステップ** 📝
- 環境変数の安全な管理（.env）
- ファイルアクセス権限の適切な設定
- APIキーと認証情報の保護

### 8. テストと検証
**完了した項目** ✅
- 手動テスト手順の確立

**進行中** 🔄
- 基本的な自動テスト

**次のステップ** 📝
- 単体テストの作成
- 統合テストの実装
- 実際のユースケースでのベンチマーク
- エラー率のモニタリング（目標: 0.1%以下）

### 9. ドキュメンテーション
**完了した項目** ✅
- ユーザーガイドの作成
- 分散型データベース構造の説明
- Claude Desktop設定ファイル修正手順の詳細ドキュメント
- データアクセスパターンの詳細ドキュメント（README_DATABASE_ACCESS.md）

**進行中** 🔄
- READMEの更新

**次のステップ** 📝
- API仕様書の詳細化
- サンプルプロジェクトと利用例の追加
- デモビデオとチュートリアル作成

### 10. YouTubeデータの活用と意味理解
**現状分析** 📊
- 700件の動画データの収集に成功
- Max/MSPオブジェクト名とキーワードの基礎的な抽出を実装
- 分散型データベース構造への取り込みが完了
- 動画リソースを検索・提示する基本機能あり
- Maxパッチファイル（.maxpat）の収集と分析パイプラインの構築

**完了した項目** ✅
- YouTube APIからのメタデータ収集
- チャンネル・動画情報の基本的な構造化
- グラフデータベース内のノード・リレーションシップ構築（789ノード、3324リレーション）
- 単純なキーワードとオブジェクト抽出
- maxpat収集スクリプトの実装
- maxpat分析と特徴抽出機能の実装
- MCPサーバーを通じたパターンアクセス機能の実装

**進行中** 🔄
- 収集データの品質検証
- 初期検索機能の実装
- 複雑なMaxパッチの構造分析
- 有用なパターンの抽出と分類

**次のステップ** 📝
- **トランスクリプト（字幕）データの取得と分析**：実際の説明内容を理解するため
- **チュートリアル内容の構造化**：手順、設定値、接続方法などをステップ単位で抽出
- **視覚的情報の活用**：サムネイルや動画内のパッチスクリーンショットをAI画像認識で分析
- **高品質なローカルベクトル埋め込み**：外部APIに依存せず、ローカルで実行可能なモデルを使用した意味ベクトル生成
- **実例パッチの抽出と再現**：動画から実際のパッチ構造を抽出し再現可能な形式に変換
- **関連コンテキストの統合**：YouTubeデータと既存のMax/MSPドキュメントデータを意味的に接続
- **教育的内容の抽出と整理**：チュートリアルの段階的学習パスの構築

**優先度の高い課題** ⚠️
- 単なる動画リンク提供から脱却し、LLMが内容を本質的に理解できる深い構造化が必要
- 動画コンテンツの意味理解なしにはパッチ生成能力の向上に貢献できない

## 関数アーキテクチャと運用ガイド

### 統合データアクセスアーキテクチャ

Manxoプロジェクトでは、以下の2つの主要な統合API関数を通じてデータにアクセスします：

1. **`databaseAccess`** - 分散型データベース（ベクトル/グラフ/ドキュメント）へのアクセス
2. **`maxPatternAccess`** - Maxパッチパターンデータへのアクセス

これらの関数は、引数として「アクション」を指定することで、複数の機能を1つのインターフェースから提供します。

#### databaseAccessの構造と使用方法

```javascript
// 基本構造
async function databaseAccess(params) {
  const { action, query, objectName, relationshipType, limit } = params;
  
  try {
    switch (action) {
      case 'semanticSearch': { ... }
      case 'findRelatedObjects': { ... }
      case 'documentSearch': { ... }
      case 'integratedSearch': { ... }
      default: { return { error: `不明なアクション: ${action}` }; }
    }
  } catch (error) {
    // エラー処理
    return { error: `エラーメッセージ`, action };
  }
}

// 使用例
const result = await databaseAccess({
  action: 'semanticSearch',
  query: 'フィルターエフェクト',
  limit: 5
});
```

#### maxPatternAccessの構造と使用方法

```javascript
// 基本構造
function maxPatternAccess(params) {
  try {
    const { action, query, category, purpose, complexity, limit } = params;
    
    switch (action) {
      case 'search': { ... }
      case 'recommend': { ... }
      case 'findRelated': { ... }
      default: { return { error: `不明なアクション: ${action}` }; }
    }
  } catch (error) {
    // エラー処理
    return { error: `エラーメッセージ`, action: params?.action };
  }
}

// 使用例
const result = maxPatternAccess({
  action: 'recommend',
  purpose: 'synthesis',
  complexity: 3,
  limit: 5
});
```

### 統一されたレスポンス形式

すべての関数は一貫したレスポンス形式を返します：

```javascript
// 成功時のレスポンス
{
  action: 'アクション名',
  // 要求パラメータが含まれる（例: query, objectName, purpose）
  results: {
    // アクション固有の結果データ
  }
}

// エラー時のレスポンス
{
  error: 'エラーメッセージ',
  action: 'エラーが発生したアクション'
}
```

### エラー処理パターン

1. **関数レベルの例外キャッチ**: すべての関数はtry/catchブロックでラップされ、予期しない例外を適切にハンドリング
2. **パラメータ検証**: 必須パラメータの存在と型を検証（例: クエリが空でないか、目的が有効か）
3. **結果の存在確認**: 空の結果セットを適切に処理
4. **MCPツールレベルの二重チェック**: ツールレベルでも結果とエラーを再検証

### MCPツールの登録パターン

```javascript
// ツール登録の一般的なパターン
mcpServer.registerTool({
  name: 'ツール名',
  description: '説明文',
  inputJsonSchema: {
    type: 'object',
    required: ['action'], // 最低限actionは必須
    properties: {
      action: {
        type: 'string',
        enum: ['アクション1', 'アクション2', ...],
        description: '実行するアクション'
      },
      // その他パラメータ定義
    }
  },
  execute: async (params) => {
    try {
      // 対応する関数を呼び出し
      const result = await someFunction(params);
      
      // エラーチェック
      if (result.error) return { content: result.error };
      
      // 空の結果チェック
      if (isEmpty(result.results)) {
        return { content: `結果が見つかりませんでした: ${params.query || ''}` };
      }
      
      // 結果を返す
      return { content: JSON.stringify(result, null, 2) };
    } catch (error) {
      return { content: `エラーが発生しました: ${error.message}` };
    }
  }
});
```

### 運用上の注意点

1. **新機能追加時**: 既存の関数に新しいアクションケースとして追加し、MCPツール定義のスキーマも更新する
2. **エラー監視**: ログにエラーが記録されるため、定期的にログをチェックして問題を特定
3. **キャッシュの管理**: データキャッシュは性能向上に役立つが、古いデータが使われる可能性があるため注意
4. **バックワードコンパチビリティ**: ツールインターフェースを変更する場合は、古いインターフェースもサポートするか、明示的に非推奨にする
5. **デバッグ**: 開発時は詳細なログを有効にし、本番環境では必要に応じて制限する

## MCP経由のDB利用例

### 新しい統合型ツールの使用例
**ユーザー**: 「フィルター効果を適用できるMaxオブジェクトを教えて」

**Claude処理**: databaseAccessツールを呼び出し
```json
{
  "action": "semanticSearch",
  "query": "フィルター効果を適用できるMaxオブジェクト",
  "limit": 5
}
```

**結果**:
```json
{
  "action": "semanticSearch",
  "query": "フィルター効果を適用できるMaxオブジェクト",
  "results": [
    {
      "object_name": "biquad~",
      "description": "バイクアッドフィルター。ローパス、ハイパス、バンドパス、ノッチなど様々なフィルタータイプを適用できる",
      "similarity": 0.89
    },
    {
      "object_name": "filtergraph~",
      "description": "フィルター特性をグラフィカルに編集・表示するインターフェース",
      "similarity": 0.86
    },
    // 他の結果省略
  ]
}
```

### Maxパターン推奨の例
**ユーザー**: 「シンセサイザー向けの中程度に複雑なパターンを推奨して」

**Claude処理**: maxPatternAccessツールを呼び出し
```json
{
  "action": "recommend",
  "purpose": "synthesis",
  "complexity": 3,
  "limit": 3
}
```

**結果**:
```json
{
  "action": "recommend",
  "purpose": "synthesis",
  "complexity": 3,
  "results": {
    "recommended_pairs": [
      {
        "source": "cycle~",
        "destination": "selector~",
        "count": 78,
        "score": 2.4
      },
      {
        "source": "phasor~",
        "destination": "wave~",
        "count": 65,
        "score": 2.1
      }
    ],
    "recommended_feedback": [
      {
        "objects": ["cycle~", "phasor~", "*~", "+~"],
        "count": 45,
        "score": 1.9
      }
    ]
  }
}
```

## 優先順位
1. MCPツールの関数とレスポンス形式の統一（完了）
2. セキュリティ強化（短期）
3. マルチプラットフォーム対応計画（短期）
4. MCP連携機能の完成（短期）
5. 分散型DBの完全ローカル実装の維持とパフォーマンス最適化（中期）
6. エラーハンドリングとログ機能の改善（中期）
7. ユーザー体験の向上（中期）
8. テスト自動化（長期）
9. ドキュメント拡充（長期）

## マイルストーン
- **v0.7**: セキュリティ強化 - 1週間以内
- **v0.8**: MCP連携機能完成 - 2週間以内
- **v0.9**: ユーザー体験向上 - 3週間以内
- **v1.0**: 本番リリース（macOS対応） - 1ヶ月以内
- **v1.1**: パフォーマンス最適化 - 2ヶ月以内
- **v1.2**: 追加プラットフォームサポート検討 - 3ヶ月以内
